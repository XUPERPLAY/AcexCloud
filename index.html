<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Premium - WebTorrent</title>
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5em;
            background: linear-gradient(45deg, #00f2ff, #0066ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .info-box {
            background: rgba(0, 242, 255, 0.1);
            border: 1px solid rgba(0, 242, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px auto;
            max-width: 900px;
            text-align: center;
            font-size: 14px;
        }

        #player-container { 
            width: 100%; 
            max-width: 900px; 
            margin: 0 auto 30px; 
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            border: 2px solid rgba(0,242,255,0.3);
        }

        .controls-section {
            max-width: 900px;
            margin: 0 auto 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        #search-bar { 
            flex: 1;
            min-width: 250px;
            padding: 15px 25px; 
            border-radius: 30px; 
            border: 2px solid rgba(0,242,255,0.3); 
            font-size: 16px; 
            background: rgba(0,0,0,0.4);
            color: white;
            outline: none;
        }

        #search-bar:focus {
            border-color: #00f2ff;
            box-shadow: 0 0 20px rgba(0,242,255,0.2);
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #0066ff, #00f2ff);
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,102,255,0.4);
        }

        #status-box {
            max-width: 900px;
            margin: 20px auto;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            text-align: center;
            display: none;
        }

        #status-box.active {
            display: block;
        }

        .peer-count {
            color: #00f2ff;
            font-weight: bold;
            font-size: 18px;
        }

        #channel-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            max-width: 900px;
            margin: 20px auto;
            max-height: 500px;
            overflow-y: auto;
        }

        .channel-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .channel-card:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-3px);
            border-color: rgba(0,242,255,0.5);
        }

        .channel-card.active {
            background: rgba(0,102,255,0.2);
            border-color: #00f2ff;
        }

        .channel-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin: 0 auto 10px;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            padding: 5px;
        }

        .channel-name {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .channel-group {
            font-size: 10px;
            color: #00f2ff;
            text-transform: uppercase;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00f2ff, #0066ff);
            width: 0%;
            transition: width 0.3s;
        }

        .warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.5);
            color: #ffc107;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>âš¡ TV PREMIUM WEB</h1>
    <p>ReproducciÃ³n P2P directa en tu navegador</p>
</div>

<div class="info-box">
    ðŸ’¡ <strong>Modo WebTorrent:</strong> Los videos se descargan directamente de otros usuarios (P2P). 
    Puede tardar 10-60 segundos en iniciar dependiendo de los peers disponibles.
</div>

<div id="player-container">
    <div id="dplayer"></div>
</div>

<div id="status-box">
    <div id="status-text">Listo</div>
    <div style="margin-top: 10px;">
        Peers conectados: <span class="peer-count" id="peers">0</span> | 
        Progreso: <span id="progress">0%</span>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" id="progress-bar"></div>
    </div>
</div>

<div class="controls-section">
    <input type="text" id="search-bar" placeholder="ðŸ” Buscar canal..." onkeyup="filterChannels()">
    <button class="btn" onclick="loadM3U()">ðŸ”„ Cargar Lista</button>
</div>

<div id="channel-list">
    <div style="text-align: center; padding: 40px; color: #888; grid-column: 1/-1;">
        Clic en "Cargar Lista" para ver los canales
    </div>
</div>

<script>
    // Inicializar WebTorrent y DPlayer
    const client = new WebTorrent();
    let currentTorrent = null;
    let channels = [];
    let dp = null;

    // Inicializar DPlayer
    function initPlayer() {
        dp = new DPlayer({
            container: document.getElementById('dplayer'),
            video: { url: '' },
            autoplay: true,
            theme: '#00f2ff',
            lang: 'es',
            screenshot: true,
            airplay: true
        });
    }

    initPlayer();

    // Escuchar eventos de WebTorrent
    client.on('error', (err) => {
        console.error('WebTorrent error:', err);
        updateStatus('Error: ' + err.message);
    });

    function updateStatus(text) {
        document.getElementById('status-text').textContent = text;
        document.getElementById('status-box').classList.add('active');
    }

    function updatePeers(count) {
        document.getElementById('peers').textContent = count;
    }

    function updateProgress(percent) {
        document.getElementById('progress').textContent = percent + '%';
        document.getElementById('progress-bar').style.width = percent + '%';
    }

    // Convertir hash AceStream a magnet link
    function acestreamToMagnet(hash) {
        hash = hash.trim().replace('acestream://', '').toLowerCase();
        
        const trackers = [
            'udp://tracker.openbittorrent.com:80',
            'udp://tracker.opentrackr.org:1337',
            'udp://tracker.coppersurfer.tk:6969',
            'udp://tracker.leechers-paradise.org:6969',
            'udp://exodus.desync.com:6969',
            'udp://tracker.pirateparty.gr:6969',
            'udp://tracker.internetwarriors.net:1337',
            'wss://tracker.openwebtorrent.com',
            'wss://tracker.btorrent.xyz'
        ];
        
        let magnet = `magnet:?xt=urn:btih:${hash}`;
        trackers.forEach(tr => {
            magnet += `&tr=${encodeURIComponent(tr)}`;
        });
        
        return magnet;
    }

    // Cargar lista M3U
    async function loadM3U() {
        updateStatus('Cargando lista de canales...');
        
        try {
            const response = await fetch('/api/m3u');
            const data = await response.text();
            parseM3U(data);
            updateStatus('Lista cargada. Selecciona un canal.');
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('channel-list').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #ff4444; grid-column: 1/-1;">
                    Error al cargar la lista. <button onclick="loadM3U()" class="btn" style="margin-left: 10px;">Reintentar</button>
                </div>
            `;
        }
    }

    function parseM3U(content) {
        channels = [];
        const lines = content.split('\n');
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            if (line.startsWith('#EXTINF')) {
                const nameMatch = line.match(/,(.*)$/);
                const name = nameMatch ? nameMatch[1].trim() : 'Sin nombre';
                const logo = line.match(/tvg-logo="(.*?)"/)?.[1] || '';
                const group = line.match(/group-title="(.*?)"/)?.[1] || 'General';
                const streamUrl = lines[i+1]?.trim();
                
                if (streamUrl && streamUrl.includes('acestream://')) {
                    const aceId = streamUrl.split('acestream://')[1].trim();
                    if (/^[a-f0-9]{40}$/i.test(aceId)) {
                        channels.push({ name, logo, aceId, group, id: aceId.substring(0, 8) });
                    }
                }
            }
        }
        
        // Ordenar
        channels.sort((a, b) => a.group.localeCompare(b.group) || a.name.localeCompare(b.name));
        
        displayChannels(channels);
        updateStatus(`âœ… ${channels.length} canales cargados. Haz clic en uno para reproducir.`);
    }

    function displayChannels(list) {
        const container = document.getElementById('channel-list');
        
        if (list.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #888; grid-column: 1/-1;">No se encontraron canales AceStream</div>';
            return;
        }
        
        container.innerHTML = list.map(c => `
            <div class="channel-card" onclick="playChannel('${c.aceId}', '${escapeHtml(c.name)}', this)" data-id="${c.aceId}">
                <img src="${c.logo}" class="channel-logo" onerror="this.src='https://via.placeholder.com/60?text=TV'" alt="${escapeHtml(c.name)}">
                <div class="channel-group">${escapeHtml(c.group)}</div>
                <div class="channel-name">${escapeHtml(c.name)}</div>
                <div style="font-size: 10px; color: #666; margin-top: 5px;">${c.id}</div>
            </div>
        `).join('');
    }

    async function playChannel(hash, name, element) {
        // UI updates
        document.querySelectorAll('.channel-card').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        
        // Limpiar torrent anterior
        if (currentTorrent) {
            currentTorrent.destroy();
        }

        updateStatus(`â³ Conectando a "${name}"... Espera mientras encuentra peers...`);
        updatePeers(0);
        updateProgress(0);

        const magnetUri = acestreamToMagnet(hash);
        console.log('Reproduciendo:', magnetUri);

        try {
            client.add(magnetUri, (torrent) => {
                currentTorrent = torrent;
                
                console.log('Torrent aÃ±adido:', torrent.name || hash);
                
                // Eventos del torrent
                torrent.on('wire', () => {
                    updatePeers(torrent.numPeers);
                });

                torrent.on('download', (bytes) => {
                    const percent = Math.round(torrent.progress * 100);
                    updateProgress(percent);
                    updateStatus(`ðŸ“¥ Descargando... ${(torrent.downloaded / 1024 / 1024).toFixed(2)} MB`);
                    updatePeers(torrent.numPeers);
                });

                // Buscar archivo de video
                const videoFile = torrent.files.find(f => {
                    const ext = f.name.toLowerCase().split('.').pop();
                    return ['mp4', 'mkv', 'avi', 'mov', 'webm', 'ts'].includes(ext);
                }) || torrent.files[0];

                if (!videoFile) {
                    updateStatus('âŒ No se encontrÃ³ archivo de video');
                    return;
                }

                // Renderizar en el DOM para reproducir
                videoFile.renderTo('video', {
                    autoplay: true,
                    controls: true
                }, (err, elem) => {
                    if (err) {
                        console.error('Error renderizando:', err);
                        // Fallback: usar URL blob
                        videoFile.getBlobURL((err, url) => {
                            if (err) {
                                updateStatus('âŒ Error al cargar el video');
                                return;
                            }
                            playInDPlayer(url, name);
                        });
                    } else {
                        updateStatus(`â–¶ Reproduciendo: ${name}`);
                        updatePeers(torrent.numPeers);
                    }
                });
            });
        } catch (error) {
            console.error('Error:', error);
            updateStatus('âŒ Error al iniciar la reproducciÃ³n');
        }
    }

    function playInDPlayer(url, name) {
        dp.switchVideo({
            url: url,
            type: 'auto',
            name: name
        });
        updateStatus(`â–¶ Reproduciendo: ${name}`);
    }

    function filterChannels() {
        const query = document.getElementById('search-bar').value.toLowerCase().trim();
        if (!query) {
            displayChannels(channels);
            return;
        }
        
        const filtered = channels.filter(c => 
            c.name.toLowerCase().includes(query) || 
            c.group.toLowerCase().includes(query)
        );
        displayChannels(filtered);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Cargar automÃ¡ticamente al iniciar
    window.addEventListener('load', () => {
        setTimeout(loadM3U, 1000);
    });
</script>

</body>
</html>
